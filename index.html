<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equation to Latex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        accent: '#f59e0b'
                    }
                }
            }
        }
    </script>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .symbol-tab.active {
            background-color: #3b82f6;
            color: white;
        }
        .symbol-tab:hover:not(.active) {
            background-color: #dbeafe;
        }
        .history-item:hover {
            background-color: #f3f4f6;
        }
        .equation-preview {
            min-height: 80px;
            overflow-x: auto;
        }
        .latex-output {
            min-height: 60px;
            resize: vertical;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        .mq-editable-field {
            width: 100% !important;
            min-height: 80px !important;
            border: none !important;
            padding: 0.5rem !important;
            font-size: 1.5rem !important;
        }
        .mq-math-mode {
            border: none !important;
        }
        .mq-root-block {
            width: 100% !important;
        }
        .mq-editable-field .mq-cursor {
            border-left: 1px solid black !important;
        }
        .mathquill-editable {
            cursor: text;
            font-family: Symbola, "Times New Roman", serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="w-screen h-screen p-0 sm:p-4">
        <div class="bg-white sm:rounded-xl shadow-lg overflow-hidden w-full h-full flex flex-col">
            <div class="p-6 md:p-8 flex-1 overflow-y-auto">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">Equation Preview (Editable)</label>
                        <div class="flex space-x-2">
                            <button id="toggle-help" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded flex items-center">
                                <i class="fas fa-question mr-1"></i> Help
                            </button>
                        </div>
                    </div>
                    <div id="equation-preview" class="equation-preview w-full border-2 border-gray-300 rounded-lg p-4 text-2xl text-gray-800 flex items-center justify-center bg-gray-50 custom-scrollbar">
                        <span class="text-gray-400">Click here to start editing your equation</span>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label for="latex-output" class="block text-sm font-medium text-gray-700">LaTeX Code (Read-only)</label>
                        <div class="flex space-x-2">
                            <button id="auto-format" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded flex items-center">
                                <i class="fas fa-magic mr-1"></i> Auto Format
                            </button>
                        </div>
                    </div>
                    <textarea id="latex-output" class="latex-output w-full bg-gray-100 border border-gray-300 rounded-lg p-3 text-gray-700 font-mono text-sm custom-scrollbar" placeholder="LaTeX code will appear here" spellcheck="false" readonly></textarea>
                </div>
                
                <div class="mb-4">
                    <div class="flex flex-wrap border-b border-gray-200">
                        <button class="symbol-tab px-4 py-2 text-sm font-medium rounded-t-lg active" data-category="common">Common</button>
                        <button class="symbol-tab px-4 py-2 text-sm font-medium rounded-t-lg" data-category="greek">Greek</button>
                        <button class="symbol-tab px-4 py-2 text-sm font-medium rounded-t-lg" data-category="operators">Operators</button>
                        <button class="symbol-tab px-4 py-2 text-sm font-medium rounded-t-lg" data-category="functions">Functions</button>
                    </div>
                </div>
                
                <div id="greek-toggle-container" class="mb-4 hidden">
                    <div class="flex items-center justify-center">
                        <span class="mr-2 text-sm text-gray-700">Lowercase</span>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none">
                            <input type="checkbox" name="greek-case-toggle" id="greek-case-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="greek-case-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <span class="ml-2 text-sm text-gray-700">Uppercase</span>
                    </div>
                </div>
                
                <div id="symbol-grid" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-12 gap-2 mb-6">
                </div>
                
                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="clear-button" class="flex-1 min-w-[120px] py-3 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors flex items-center justify-center">
                        <i class="fas fa-eraser mr-2"></i> Clear
                    </button>
                    <button id="backspace-button" class="flex-1 min-w-[120px] py-3 px-4 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-colors flex items-center justify-center">
                        <i class="fas fa-backspace mr-2"></i> Backspace
                    </button>
                    <button id="save-button" class="flex-1 min-w-[120px] py-3 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> Save
                    </button>
                    <button id="copy-button" class="flex-1 min-w-[120px] py-3 px-4 bg-primary text-white font-semibold rounded-lg hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors flex items-center justify-center">
                        <i class="fas fa-copy mr-2"></i> Copy LaTeX
                    </button>
                </div>
                
                <div id="feedback-message" class="text-center font-medium mb-6 h-6"></div>
                
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Equation History</h2>
                        <button id="clear-history" class="text-sm text-gray-500 hover:text-gray-700 flex items-center">
                            <i class="fas fa-trash-alt mr-1"></i> Clear History
                        </button>
                    </div>
                    <div id="history-list" class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto custom-scrollbar">
                        <p class="text-gray-500 text-center py-4">No equations saved yet</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">Equation Editor Help</h3>
                        <button id="close-help" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-2">Basic Usage</h4>
                        <ul class="list-disc pl-5 text-gray-600 space-y-1">
                            <li>Click on the equation preview area to start editing</li>
                            <li>Type mathematical expressions directly</li>
                            <li>LaTeX code will be generated automatically in the read-only area below</li>
                            <li>Use the symbol buttons to insert complex mathematical symbols</li>
                            <li>Save equations to your history for later use</li>
                        </ul>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-2">MathQuill Keyboard Shortcuts</h4>
                        <ul class="list-disc pl-5 text-gray-600 space-y-1">
                            <li>Type / for fractions: a/b becomes \(\frac{a}{b}\)</li>
                            <li>Type ^ for exponents: x^2 becomes \(x^{2}\)</li>
                            <li>Type _ for subscripts: x_1 becomes \(x_{1}\)</li>
                            <li>Type \sqrt for square roots</li>
                            <li>Type \frac for fractions</li>
                            <li>Type Greek letter names for Greek symbols: \alpha, \beta, etc.</li>
                            <li>Use arrow keys to navigate through the equation</li>
                            <li>Press Tab to move to the next placeholder in templates</li>
                        </ul>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-2">Common LaTeX Commands</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-300">
                                        <th class="text-left py-2">Type This</th>
                                        <th class="text-left py-2">Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">a/b</td><td class="py-2">\(\frac{a}{b}\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">x^2</td><td class="py-2">\(x^{2}\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">x_1</td><td class="py-2">\(x_{1}\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\sqrt(x)</td><td class="py-2">\(\sqrt{x}\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\sum_(i=1)^n</td><td class="py-2">\(\sum_{i=1}^{n}\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\int_a^b</td><td class="py-2">\(\int_{a}^{b}\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\alpha, \beta, \gamma</td><td class="py-2">\(\alpha, \beta, \gamma\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\neq</td><td class="py-2">\(\neq\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\leq, \geq</td><td class="py-2">\(\leq, \geq\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\pm</td><td class="py-2">\(\pm\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\infty</td><td class="py-2">\(\infty\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\to</td><td class="py-2">\(\to\)</td></tr>
                                    <tr class="border-b border-gray-200"><td class="py-2 font-mono">\sin(x), \cos(x)</td><td class="py-2">\(\sin(x), \cos(x)\)</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Tips</h4>
                        <ul class="list-disc pl-5 text-gray-600 space-y-1">
                            <li>Use the symbol buttons for complex symbols you can't type easily</li>
                            <li>Click on saved equations in the history to load them back into the editor</li>
                            <li>Use the backspace button to remove the last character</li>
                            <li>Your equations are saved locally in your browser</li>
                            <li>Use the toggle in the Greek tab to switch between lowercase and uppercase Greek letters</li>
                        </ul>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 flex justify-end">
                    <button id="close-help-bottom" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                        Got it!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let mathField;
        let currentCategory = 'common';
        let isGreekUppercase = false;
        let equationHistory = JSON.parse(localStorage.getItem('equationHistory')) || [];

        // Symbol categories
        const symbolCategories = {
            common: [
                { display: '\\frac{⬚}{⬚}', latex: '\/', description: 'Fraction' },
                { display: '\\sqrt{⬚}', latex: '\\sqrt', description: 'Square Root' },
                { display: '\\sqrt[⬚]{⬚}', latex: '\\nthroot', description: 'n-th Root' },
                { display: 'x^{⬚}', latex: '^', description: 'Superscript' },
                { display: 'x_{⬚}', latex: '_', description: 'Subscript' },
                { display: '\\sum', latex: '\\sum', description: 'Summation' },
                { display: '\\prod', latex: '\\prod', description: 'Product' },
                { display: '\\int_{⬚}^{⬚}', latex: '\\int', description: 'Integral' },
                { display: '\\lim_{x \\to 0}', latex: '\\lim', description: 'Limit' },
                { display: '\\binom{⬚}{⬚}', latex: '\\choose', description: 'Binomial' },
                { display: '\\left(\\right)', latex: '(', description: 'Parentheses' },
                { display: '\\left[\\right]', latex: '[', description: 'Brackets' },
                { display: '\\left\\{\\right\\}', latex: '{', description: 'Braces' },
                { display: '+', latex: '+', description: 'Plus' },
                { display: '-', latex: '-', description: 'Minus' },
                { display: '\\times', latex: '\\times', description: 'Times' },
                { display: '\\div', latex: '\\div', description: 'Divide' },
                { display: '=', latex: '=', description: 'Equals' },
                { display: '\\neq', latex: '\\neq', description: 'Not Equal' },
                { display: '\\pm', latex: '\\pm', description: 'Plus/Minus' },
                { display: '\\infty', latex: '\\infty', description: 'Infinity' },
				{ display: '\\bar{⬚}', latex: '\\bar', description: 'Bar' },
				{ display: '\\vec{⬚}', latex: '\\vec', description: 'Vector' },
				{ display: '\\mathbf{A}', latex: '\\mathbf', description: 'Bold' },
                { display: '\\partial', latex: '\\partial', description: 'Partial derivative' },
                { display: '\\nabla', latex: '\\nabla', description: 'Nabla' },
                { display: '\\to', latex: '\\to', description: 'To' },
            ],
            greek: {
                lowercase: [
                    { display: '\\alpha', latex: '\\alpha', description: 'Alpha' },
                    { display: '\\beta', latex: '\\beta', description: 'Beta' },
                    { display: '\\gamma', latex: '\\gamma', description: 'Gamma' },
                    { display: '\\delta', latex: '\\delta', description: 'Delta' },
                    { display: '\\epsilon', latex: '\\epsilon', description: 'Epsilon' },
                    { display: '\\zeta', latex: '\\zeta', description: 'Zeta' },
                    { display: '\\eta', latex: '\\eta', description: 'Eta' },
                    { display: '\\theta', latex: '\\theta', description: 'Theta' },
                    { display: '\\iota', latex: '\\iota', description: 'Iota' },
                    { display: '\\kappa', latex: '\\kappa', description: 'Kappa' },
                    { display: '\\lambda', latex: '\\lambda', description: 'Lambda' },
                    { display: '\\mu', latex: '\\mu', description: 'Mu' },
                    { display: '\\nu', latex: '\\nu', description: 'Nu' },
                    { display: '\\xi', latex: '\\xi', description: 'Xi' },
                    { display: '\\pi', latex: '\\pi', description: 'Pi' },
                    { display: '\\rho', latex: '\\rho', description: 'Rho' },
                    { display: '\\sigma', latex: '\\sigma', description: 'Sigma' },
                    { display: '\\tau', latex: '\\tau', description: 'Tau' },
                    { display: '\\upsilon', latex: '\\upsilon', description: 'Upsilon' },
                    { display: '\\phi', latex: '\\phi', description: 'Phi' },
                    { display: '\\chi', latex: '\\chi', description: 'Chi' },
                    { display: '\\psi', latex: '\\psi', description: 'Psi' },
                    { display: '\\omega', latex: '\\omega', description: 'Omega' },
					{ display: '\\hbar', latex: '\\hbar', description: 'Omega' },
                ],
                uppercase: [
                    { display: 'A', latex: 'A', description: 'Capital Alpha' },
                    { display: 'B', latex: 'B', description: 'Capital Beta' },
                    { display: '\\Gamma', latex: '\\Gamma', description: 'Capital Gamma' },
                    { display: '\\Delta', latex: '\\Delta', description: 'Capital Delta' },
                    { display: 'E', latex: 'E', description: 'Capital Epsilon' },
                    { display: 'Z', latex: 'Z', description: 'Capital Zeta' },
                    { display: 'H', latex: 'H', description: 'Capital Eta' },
                    { display: '\\Theta', latex: '\\Theta', description: 'Capital Theta' },
                    { display: 'I', latex: 'I', description: 'Capital Iota' },
                    { display: 'K', latex: 'K', description: 'Capital Kappa' },
                    { display: '\\Lambda', latex: '\\Lambda', description: 'Capital Lambda' },
                    { display: 'M', latex: 'M', description: 'Capital Mu' },
                    { display: 'N', latex: 'N', description: 'Capital Nu' },
                    { display: '\\Xi', latex: '\\Xi', description: 'Capital Xi' },
                    { display: '\\Pi', latex: '\\Pi', description: 'Capital Pi' },
                    { display: 'P', latex: 'P', description: 'Capital Rho' },
                    { display: '\\Sigma', latex: '\\Sigma', description: 'Capital Sigma' },
                    { display: 'T', latex: 'T', description: 'Capital Tau' },
                    { display: '\\Upsilon', latex: '\\Upsilon', description: 'Capital Upsilon' },
                    { display: '\\Phi', latex: '\\Phi', description: 'Capital Phi' },
                    { display: 'X', latex: 'X', description: 'Capital Chi' },
                    { display: '\\Psi', latex: '\\Psi', description: 'Capital Psi' },
                    { display: '\\Omega', latex: '\\Omega', description: 'Capital Omega' }
                ]
            },
            operators: [
                { display: '+', latex: '+', description: 'Plus' },
                { display: '-', latex: '-', description: 'Minus' },
                { display: '\\times', latex: '\\times', description: 'Times' },
                { display: '\\div', latex: '\\div', description: 'Divide' },
                { display: '\\cdot', latex: '\\cdot', description: 'Dot' },
                { display: '\\pm', latex: '\\pm', description: 'Plus/Minus' },
                { display: '\\mp', latex: '\\mp', description: 'Minus/Plus' },
                { display: '=', latex: '=', description: 'Equals' },
                { display: '\\neq', latex: '\\neq', description: 'Not Equal' },
                { display: '\\approx', latex: '\\approx', description: 'Approximately' },
                { display: '\\equiv', latex: '\\equiv', description: 'Equivalent' },
                { display: '\\propto', latex: '\\propto', description: 'Proportional' },
                { display: '>', latex: '>', description: 'Greater than' },
                { display: '<', latex: '<', description: 'Less than' },
                { display: '\\leq', latex: '\\leq', description: 'Less than or equal' },
                { display: '\\geq', latex: '\\geq', description: 'Greater than or equal' },
                { display: '\\subset', latex: '\\subset', description: 'Subset' },
                { display: '\\supset', latex: '\\supset', description: 'Superset' },
                { display: '\\in', latex: '\\in', description: 'Element of' },
                { display: '\\notin', latex: '\\notin', description: 'Not element of' },
                { display: '\\forall', latex: '\\forall', description: 'For all' },
                { display: '\\exists', latex: '\\exists', description: 'There exists' },
                { display: '\\rightarrow', latex: '\\rightarrow', description: 'Right arrow' },
                { display: '\\leftarrow', latex: '\\leftarrow', description: 'Left arrow' },
                { display: '\\Rightarrow', latex: '\\Rightarrow', description: 'Double right arrow' },
                { display: '\\Leftarrow', latex: '\\Leftarrow', description: 'Double left arrow' },
            ],
            functions: [
                { display: '\\sin', latex: '\\sin', description: 'Sine' },
				{ display: '\\cos', latex: '\\cos', description: 'Cosine' },
				{ display: '\\tan', latex: '\\tan', description: 'Tangent' },
				{ display: '\\cot', latex: '\\cot', description: 'Cotangent' },
				{ display: '\\sec', latex: '\\sec', description: 'Secant' },
				{ display: '\\csc', latex: '\\csc', description: 'Cosecant' },
				{ display: '\\arcsin', latex: '\\arcsin', description: 'Arcsine' },
				{ display: '\\arccos', latex: '\\arccos', description: 'Arccosine' },
				{ display: '\\arctan', latex: '\\arctan', description: 'Arctangent' },
				{ display: '\\sinh', latex: '\\sinh', description: 'Hyperbolic sine' },
				{ display: '\\cosh', latex: '\\cosh', description: 'Hyperbolic cosine' },
				{ display: '\\tanh', latex: '\\tanh', description: 'Hyperbolic tangent' },
				{ display: '\\log', latex: '\\log', description: 'Logarithm' },
				{ display: '\\ln', latex: '\\ln', description: 'Natural log' },
				{ display: '\\exp', latex: '\\exp', description: 'Exponential' },
				{ display: '\\det', latex: '\\det', description: 'Determinant' },
				
            ]
        };

        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initEditor();
        });

        function initEditor() {
            const equationPreview = document.getElementById('equation-preview');
            const latexOutput = document.getElementById('latex-output');
            const symbolGrid = document.getElementById('symbol-grid');
            const symbolTabs = document.querySelectorAll('.symbol-tab');
            const greekToggleContainer = document.getElementById('greek-toggle-container');
            const greekCaseToggle = document.getElementById('greek-case-toggle');
            const copyButton = document.getElementById('copy-button');
            const clearButton = document.getElementById('clear-button');
            const backspaceButton = document.getElementById('backspace-button');
            const saveButton = document.getElementById('save-button');
            const feedbackMessage = document.getElementById('feedback-message');
            const historyList = document.getElementById('history-list');
            const clearHistoryButton = document.getElementById('clear-history');
            const autoFormatButton = document.getElementById('auto-format');
            const toggleHelpButton = document.getElementById('toggle-help');
            const helpModal = document.getElementById('help-modal');
            const closeHelpButtons = document.querySelectorAll('#close-help, #close-help-bottom');

            // Initialize MathQuill
            const MQ = MathQuill.getInterface(2);
            const mathFieldSpan = document.createElement('span');
            mathFieldSpan.id = 'math-field';
            mathFieldSpan.className = 'w-full h-full';
            equationPreview.innerHTML = '';
            equationPreview.appendChild(mathFieldSpan);
            
            mathField = MQ.MathField(mathFieldSpan, {
                spaceBehavesLikeTab: true,
                handlers: {
                    edit: function() {
                        // Update LaTeX output when MathQuill field changes
                        const latex = mathField.latex();
                        latexOutput.value = latex;
                    }
                }
            });

            // Initialize the editor
            loadSymbols(currentCategory);
            loadHistory();

            // Event listeners
            symbolTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    symbolTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    loadSymbols(currentCategory);
                });
            });
            
            greekCaseToggle.addEventListener('change', () => {
                isGreekUppercase = greekCaseToggle.checked;
                if (currentCategory === 'greek') {
                    loadSymbols('greek');
                }
            });
            
            copyButton.addEventListener('click', () => {
                const latexCode = latexOutput.value.trim();
                if (latexCode === '') {
                    showFeedback('Nothing to copy', true);
                    return;
                }
				const textToCopy = `$$${latexCode}$$`;
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        showFeedback('LaTeX copied to clipboard');
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        const textArea = document.createElement('textarea');
                        textArea.value = latexCode;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            showFeedback('LaTeX copied to clipboard');
                        } catch (fallbackErr) {
                            console.error('Fallback copy failed: ', fallbackErr);
                            showFeedback('Failed to copy', true);
                        }
                        document.body.removeChild(textArea);
                    });
            });

            clearButton.addEventListener('click', () => {
                mathField.latex('');
                latexOutput.value = '';
                mathField.focus();
                showFeedback('Editor cleared');
            });
            
            backspaceButton.addEventListener('click', () => {
                mathField.keystroke('Backspace');
                mathField.focus();
            });
            
            saveButton.addEventListener('click', saveEquation);
            
            clearHistoryButton.addEventListener('click', clearHistory);
            
            autoFormatButton.addEventListener('click', autoFormat);
            
            toggleHelpButton.addEventListener('click', () => {
                helpModal.classList.remove('hidden');
            });
            
            closeHelpButtons.forEach(button => {
                button.addEventListener('click', () => {
                    helpModal.classList.add('hidden');
                });
            });
            
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.classList.add('hidden');
                }
            });

            // Set focus to MathQuill field
            mathField.focus();
        }

        function loadSymbols(category) {
            const symbolGrid = document.getElementById('symbol-grid');
            symbolGrid.innerHTML = '';
            let symbols = [];
            if (category === 'greek') {
                document.getElementById('greek-toggle-container').classList.remove('hidden');
                symbols = isGreekUppercase ? symbolCategories.greek.uppercase : symbolCategories.greek.lowercase;
            } else {
                document.getElementById('greek-toggle-container').classList.add('hidden');
                symbols = symbolCategories[category];
            }
            symbols.forEach(symbol => {
                const button = document.createElement('button');
                button.innerHTML = `\\(${symbol.display}\\)`;
                button.dataset.latex = symbol.latex;
                button.title = symbol.description;
                button.className = 'py-3 bg-gray-100 rounded-md hover:bg-gray-200 text-lg text-gray-800 transition-colors focus:outline-none focus:ring-2 focus:ring-primary flex items-center justify-center fade-in';
                button.addEventListener('click', () => {
                    insertSymbol(symbol.latex);
                });
                symbolGrid.appendChild(button);
            });
            
            // Re-render MathJax for the symbol buttons
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                MathJax.typesetPromise([symbolGrid]).catch((err) => console.log(err.message));
            }
        }

        function insertSymbol(latex) {
            mathField.cmd(latex);
            mathField.focus();
        }

        function showFeedback(message, isError = false) {
            const feedbackMessage = document.getElementById('feedback-message');
            feedbackMessage.textContent = message;
            feedbackMessage.className = `text-center font-medium mb-6 h-6 ${isError ? 'text-red-600' : 'text-green-600'}`;
            setTimeout(() => {
                feedbackMessage.textContent = '';
                feedbackMessage.className = 'text-center font-medium mb-6 h-6';
            }, 3000);
        }

        function saveEquation() {
            const latexOutput = document.getElementById('latex-output');
            const latex = latexOutput.value.trim();
            
            if (latex === '') {
                showFeedback('Cannot save empty equation', true);
                return;
            }
            
            if (equationHistory.includes(latex)) {
                showFeedback('Equation already saved', true);
                return;
            }
            
            equationHistory.unshift(latex);
            if (equationHistory.length > 10) {
                equationHistory.pop();
            }
            localStorage.setItem('equationHistory', JSON.stringify(equationHistory));
            loadHistory();
            showFeedback('Equation saved to history');
        }

        function loadHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (equationHistory.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-4">No equations saved yet</p>';
                return;
            }
            
            equationHistory.forEach((latex, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item p-3 border-b border-gray-200 last:border-b-0 cursor-pointer flex justify-between items-center';
                
                const equationPreview = document.createElement('div');
                equationPreview.className = 'text-sm overflow-hidden whitespace-nowrap overflow-ellipsis flex-1';
                equationPreview.innerHTML = `\\[${latex}\\]`;
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-gray-400 hover:text-red-500 ml-2';
                deleteButton.innerHTML = '<i class="fas fa-times"></i>';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteEquation(index);
                });
                
                historyItem.appendChild(equationPreview);
                historyItem.appendChild(deleteButton);
                historyItem.addEventListener('click', () => {
                    mathField.latex(latex);
                    showFeedback('Equation loaded');
                });
                
                historyList.appendChild(historyItem);
            });
            
            // Re-render MathJax for the history items
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                MathJax.typesetPromise([historyList]).catch((err) => console.log(err.message));
            }
        }

        function deleteEquation(index) {
            equationHistory.splice(index, 1);
            localStorage.setItem('equationHistory', JSON.stringify(equationHistory));
            loadHistory();
            showFeedback('Equation deleted');
        }

        function clearHistory() {
            equationHistory = [];
            localStorage.removeItem('equationHistory');
            loadHistory();
            showFeedback('History cleared');
        }

        function autoFormat() {
            const latexOutput = document.getElementById('latex-output');
            let latex = latexOutput.value;
            
            // Add spaces around operators for better readability
            latex = latex
                .replace(/([+\-*/=])/g, ' $1 ')
                .replace(/\s+/g, ' ')
                .trim();
            
            latexOutput.value = latex;
            showFeedback('LaTeX code formatted');
        }

        // MathJax configuration
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                tags: 'ams'
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>
